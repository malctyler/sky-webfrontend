<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Security Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input, select { padding: 8px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîí Password Security Testing</h1>
    
    <div class="test-section">
        <h2>Test Credentials</h2>
        <p>Try these common admin credentials:</p>
        <ul>
            <li>Email: <code>admin@example.com</code>, Password: <code>Admin123!</code></li>
            <li>Email: <code>admin@skyinspections.com</code>, Password: <code>Admin123!</code></li>
            <li>Email: <code>test@example.com</code>, Password: <code>TestPassword123!</code></li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Password Security Demo</h2>
        <label for="test-email">Email:</label>
        <input type="email" id="test-email" value="admin@example.com" style="width: 200px;">
        
        <label for="test-password">Password:</label>
        <input type="password" id="test-password" value="Admin123!" style="width: 200px;">
        
        <button onclick="testPasswordHashing()">Test Password Hashing</button>
        <button onclick="testLoginRequest()">Test Login Request</button>
        
        <div id="hash-result" style="margin-top: 10px;"></div>
    </div>

    <div class="test-section">
        <h2>Backend Status</h2>
        <button onclick="testBackendStatus()">Check Backend</button>
        <div id="backend-status"></div>
    </div>

    <div class="test-section">
        <h2>Live Console Output</h2>
        <div id="console-output" style="background: #000; color: #0f0; padding: 10px; min-height: 200px; font-family: monospace; white-space: pre-wrap;"></div>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script>
        // Override console.log to display in our custom console
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const consoleOutput = document.getElementById('console-output');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : '#0f0';
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        // Password security utility (same as frontend)
        class PasswordSecurity {
            static SALT_PREFIX = 'sky_auth_2025_';
            static ITERATIONS = 10000;
            static KEY_SIZE = 256 / 32;

            static hashPasswordForTransmission(password, email) {
                try {
                    const salt = CryptoJS.SHA256(this.SALT_PREFIX + email.toLowerCase()).toString();
                    const hash = CryptoJS.PBKDF2(password, salt, {
                        keySize: this.KEY_SIZE,
                        iterations: this.ITERATIONS,
                        hasher: CryptoJS.algo.SHA256
                    });
                    return hash.toString(CryptoJS.enc.Base64);
                } catch (error) {
                    console.error('Error hashing password:', error);
                    throw new Error('Failed to process password securely');
                }
            }

            static generateNonce() {
                const nonce = CryptoJS.lib.WordArray.random(16);
                return nonce.toString(CryptoJS.enc.Base64);
            }

            static createSecureLoginPayload(email, password) {
                const hashedPassword = this.hashPasswordForTransmission(password, email);
                const nonce = this.generateNonce();
                const timestamp = Date.now();

                return {
                    email: email.toLowerCase(),
                    passwordHash: hashedPassword,
                    nonce: nonce,
                    timestamp: timestamp
                };
            }
        }

        function testPasswordHashing() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            console.log('=== Password Hashing Test ===');
            console.log('Email:', email);
            console.log('Password:', '*'.repeat(password.length));
            
            try {
                const payload = PasswordSecurity.createSecureLoginPayload(email, password);
                console.log('‚úÖ Hashed password:', payload.passwordHash.substring(0, 20) + '...');
                console.log('‚úÖ Nonce:', payload.nonce.substring(0, 10) + '...');
                console.log('‚úÖ Timestamp:', payload.timestamp);
                
                document.getElementById('hash-result').innerHTML = `
                    <div class="success">‚úÖ Password hashed successfully!</div>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('‚ùå Password hashing failed:', error);
                document.getElementById('hash-result').innerHTML = `
                    <div class="error">‚ùå Password hashing failed: ${error.message}</div>
                `;
            }
        }

        async function testLoginRequest() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            console.log('=== Testing Login Request ===');
            
            try {
                const payload = PasswordSecurity.createSecureLoginPayload(email, password);
                console.log('Sending secure login request...');
                
                const response = await fetch('http://localhost:5207/api/auth/secure-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('Response body:', responseText);
                
                if (response.ok) {
                    console.log('‚úÖ Login successful!');
                    const data = JSON.parse(responseText);
                    if (data.token) {
                        console.log('‚úÖ Token received:', data.token.substring(0, 20) + '...');
                    }
                } else {
                    console.error('‚ùå Login failed:', response.status, responseText);
                }
                
            } catch (error) {
                console.error('‚ùå Request failed:', error);
            }
        }

        async function testBackendStatus() {
            console.log('=== Testing Backend Status ===');
            
            try {
                const response = await fetch('http://localhost:5207/api/status');
                const data = await response.json();
                console.log('‚úÖ Backend is running:', data);
                document.getElementById('backend-status').innerHTML = `
                    <div class="success">‚úÖ Backend is running</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('‚ùå Backend not reachable:', error);
                document.getElementById('backend-status').innerHTML = `
                    <div class="error">‚ùå Backend not reachable: ${error.message}</div>
                `;
            }
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        // Auto-test on page load
        window.onload = function() {
            console.log('üîí Password Security Test Page Loaded');
            console.log('Frontend: http://localhost:3001');
            console.log('Backend: http://localhost:5207');
            testBackendStatus();
        };
    </script>
</body>
</html>
