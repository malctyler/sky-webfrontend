<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Migration Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .login-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .old-login { background-color: #fff3cd; border-color: #ffeaa7; }
        .secure-login { background-color: #d1ecf1; border-color: #bee5eb; }
        input, button { padding: 10px; margin: 5px; width: 200px; }
        button { width: auto; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîê Login Migration Test</h1>
    
    <div class="info">
        <h3>Instructions:</h3>
        <ol>
            <li><strong>Step 1:</strong> Use "Old Login" first to migrate your test account</li>
            <li><strong>Step 2:</strong> Then use "Secure Login" to verify it works</li>
        </ol>
    </div>

    <div class="login-section old-login">
        <h3>üìú Old Login (Migration)</h3>
        <p>Use this first to migrate existing accounts to secure login compatibility.</p>
        <input type="email" id="oldEmail" placeholder="Email" value="tester@malcsdomain.co.uk">
        <input type="password" id="oldPassword" placeholder="Password">
        <button onclick="testOldLogin()">Login with Old Method</button>
        <div id="oldResult"></div>
    </div>

    <div class="login-section secure-login">
        <h3>üîí Secure Login (Encrypted)</h3>
        <p>Use this after migration to verify secure login works.</p>
        <input type="email" id="secureEmail" placeholder="Email" value="tester@malcsdomain.co.uk">
        <input type="password" id="securePassword" placeholder="Password">
        <button onclick="testSecureLogin()">Login with Secure Method</button>
        <div id="secureResult"></div>
    </div>

    <div id="debugOutput"></div>

    <script>
        const API_BASE = 'http://localhost:5207/api';
        
        // Simple PBKDF2 implementation for testing
        async function hashPassword(password, email) {
            const encoder = new TextEncoder();
            const saltPrefix = 'sky_auth_2025_';
            
            // Create salt
            const saltData = encoder.encode(saltPrefix + email.toLowerCase());
            const saltHash = await crypto.subtle.digest('SHA-256', saltData);
            const saltHex = Array.from(new Uint8Array(saltHash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            
            // PBKDF2
            const passwordData = encoder.encode(password);
            const saltBytes = encoder.encode(saltHex);
            
            const key = await crypto.subtle.importKey(
                'raw', passwordData, 'PBKDF2', false, ['deriveBits']
            );
            
            const derivedBits = await crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: saltBytes,
                    iterations: 10000,
                    hash: 'SHA-256'
                },
                key,
                256
            );
            
            return btoa(String.fromCharCode(...new Uint8Array(derivedBits)));
        }

        async function testOldLogin() {
            const email = document.getElementById('oldEmail').value;
            const password = document.getElementById('oldPassword').value;
            const resultDiv = document.getElementById('oldResult');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing old login...</div>';
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Old Login Successful!</div>
                        <p>Account should now be migrated for secure login.</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Old Login Failed</div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testSecureLogin() {
            const email = document.getElementById('secureEmail').value;
            const password = document.getElementById('securePassword').value;
            const resultDiv = document.getElementById('secureResult');
            
            try {
                resultDiv.innerHTML = '<div class="info">Hashing password and testing secure login...</div>';
                
                const passwordHash = await hashPassword(password, email);
                const nonce = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));
                const timestamp = Date.now();
                
                const payload = {
                    email: email.toLowerCase(),
                    passwordHash,
                    nonce,
                    timestamp
                };
                
                document.getElementById('debugOutput').innerHTML = `
                    <h4>üîç Debug Info:</h4>
                    <pre>Email: ${payload.email}
Password Hash: ${passwordHash.substring(0, 20)}...
Nonce: ${nonce.substring(0, 10)}...
Timestamp: ${timestamp}</pre>
                `;
                
                const response = await fetch(`${API_BASE}/auth/secure-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Secure Login Successful!</div>
                        <p>Password was transmitted securely (hashed).</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Secure Login Failed</div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-fill the second form when first form is used
        document.getElementById('oldEmail').addEventListener('input', (e) => {
            document.getElementById('secureEmail').value = e.target.value;
        });
        document.getElementById('oldPassword').addEventListener('input', (e) => {
            document.getElementById('securePassword').value = e.target.value;
        });
    </script>
</body>
</html>
